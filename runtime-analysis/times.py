import numpy as np
import matplotlib.pyplot as plt
from numpy.polynomial import Polynomial

# Adjust dpi for better printing quality
plt.rcParams['figure.dpi'] = 300
plt.rcParams['savefig.dpi'] = 300
plt.rcParams.update({'font.size': 16})

# Runtime data for q=5 as an example. 
# Other q were not included, since we optimized the code and changed our Magma version
# in between, and did not want to rerun everything just to measure the runtime.
datasets = {
	(5, 0): [
		(1, [0.000, 0.000, 0.000, 0.000, 0.000, 0.000]), 
		(5, [0.000, 0.000, 0.000, 0.000, 0.000, 0.000]), 
		(9, [0.000, 0.000, 0.000, 0.000, 0.010, 0.000]), 
		(13, [0.010, 0.000, 0.000, 0.000, 0.000, 0.000]), 
		(17, [0.020, 0.000, 0.000, 0.010, 0.000, 0.000]), 
		(21, [0.040, 0.010, 0.000, 0.020, 0.000, 0.000]), 
		(25, [0.090, 0.010, 0.000, 0.070, 0.000, 0.000]), 
		(29, [0.120, 0.020, 0.000, 0.180, 0.000, 0.000]), 
		(33, [0.180, 0.030, 0.000, 0.530, 0.000, 0.000]), 
		(37, [0.290, 0.050, 0.000, 1.310, 0.000, 0.000]), 
		(41, [0.420, 0.090, 0.000, 2.890, 0.000, 0.000]), 
		(45, [0.600, 0.140, 0.000, 6.030, 0.000, 0.000]), 
		(49, [0.840, 0.210, 0.000, 11.860, 0.000, 0.000]), 
		(53, [1.150, 0.310, 0.000, 22.020, 0.000, 0.000]), 
		(57, [1.520, 0.450, 0.010, 39.370, 0.000, 0.000]), 
		(61, [2.000, 0.630, 0.000, 66.610, 0.000, 0.000]), 
		(65, [2.560, 0.870, 0.000, 107.430, 0.000, 0.000]), 
		(69, [3.230, 1.170, 0.010, 166.370, 0.010, 0.000]), 
		(73, [4.050, 1.550, 0.010, 270.480, 0.000, 0.000]), 
		(77, [4.990, 2.050, 0.010, 424.300, 0.000, 0.010]), 
		(81, [6.100, 2.670, 0.020, 633.320, 0.000, 0.000]), 
		(85, [7.370, 3.390, 0.020, 908.290, 0.010, 0.000]), 
		(89, [8.850, 4.320, 0.020, 1314.820, 0.010, 0.000]), 
		(93, [10.580, 5.400, 0.020, 1847.770, 0.010, 0.000]), 
		(97, [12.530, 6.700, 0.030, 2908.860, 0.010, 0.010]), 
		(101, [14.770, 8.270, 0.040, 4065.780, 0.010, 0.010]), 
		(105, [17.260, 10.120, 0.050, 5531.040, 0.000, 0.010]), 
		(109, [20.040, 12.390, 0.060, 7410.480, 0.010, 0.000]), 
		(113, [23.180, 15.070, 0.060, 9842.440, 0.010, 0.010]), 
		(117, [26.830, 17.890, 0.080, 13559.950, 0.020, 0.000]), 
		(121, [30.650, 22.210, 0.110, 17704.150, 0.010, 0.010]), 
		(125, [34.750, 26.470, 0.120, 22420.700, 0.020, 0.010]), 
		(129, [39.610, 31.240, 0.150, 29715.490, 0.030, 0.010])
    ],
    (5, 1): [
		(0, [0.000, 0.000, 0.000, 0.000, 0.000, 0.000]), 
		(4, [0.000, 0.000, 0.000, 0.000, 0.000, 0.000]), 
		(8, [0.000, 0.000, 0.000, 0.000, 0.000, 0.000]), 
		(12, [0.010, 0.000, 0.000, 0.010, 0.000, 0.000]), 
		(16, [0.020, 0.010, 0.000, 0.030, 0.000, 0.000]), 
		(20, [0.030, 0.020, 0.000, 0.130, 0.000, 0.000]), 
		(24, [0.060, 0.020, 0.000, 0.380, 0.000, 0.000]), 
		(28, [0.100, 0.050, 0.000, 0.910, 0.000, 0.000]), 
		(32, [0.170, 0.080, 0.000, 1.930, 0.000, 0.000]), 
		(36, [0.270, 0.130, 0.000, 3.970, 0.000, 0.000]), 
		(40, [0.400, 0.200, 0.000, 7.820, 0.000, 0.000]), 
		(44, [0.590, 0.290, 0.000, 14.500, 0.000, 0.000]), 
		(48, [0.830, 0.420, 0.000, 26.340, 0.000, 0.000]), 
		(52, [1.120, 0.580, 0.010, 47.170, 0.000, 0.000]), 
		(56, [1.490, 0.810, 0.010, 80.080, 0.000, 0.000]), 
		(60, [1.960, 1.090, 0.010, 131.890, 0.000, 0.000]), 
		(64, [2.550, 1.450, 0.020, 211.190, 0.000, 0.000]), 
		(68, [3.220, 1.910, 0.020, 322.490, 0.000, 0.000]), 
		(72, [4.020, 2.500, 0.020, 489.340, 0.010, 0.000]), 
		(76, [4.980, 3.190, 0.030, 721.570, 0.000, 0.000]), 
		(80, [6.060, 4.060, 0.030, 1063.270, 0.010, 0.000]), 
		(84, [7.350, 5.060, 0.040, 1517.910, 0.000, 0.000]), 
		(88, [8.900, 6.330, 0.060, 2424.040, 0.010, 0.000]), 
		(92, [10.680, 7.760, 0.060, 3358.090, 0.000, 0.000]), 
		(96, [12.740, 9.460, 0.080, 4683.780, 0.010, 0.000]), 
		(100, [15.060, 11.660, 0.090, 6439.960, 0.010, 0.000]), 
		(104, [17.350, 14.150, 0.110, 8834.900, 0.010, 0.010]), 
		(108, [20.980, 17.060, 0.150, 11897.620, 0.010, 0.010]), 
		(112, [24.770, 20.810, 0.170, 16561.980, 0.010, 0.010]), 
		(116, [27.780, 24.180, 0.190, 21104.410, 0.020, 0.010]), 
		(120, [31.120, 29.070, 0.210, 28045.110, 0.020, 0.010]), 
		(124, [35.550, 33.870, 0.250, 35346.050, 0.030, 0.010]), 
		(128, [40.340, 41.680, 0.280, 45379.480, 0.030, 0.010])

    ],
    (5, 2): [
		(3, [0.000, 0.000, 0.000, 0.000, 0.000, 0.000]), 
		(7, [0.000, 0.000, 0.000, 0.000, 0.000, 0.000]), 
		(11, [0.010, 0.000, 0.000, 0.000, 0.000, 0.000]), 
		(15, [0.020, 0.000, 0.000, 0.020, 0.000, 0.000]), 
		(19, [0.020, 0.010, 0.000, 0.050, 0.000, 0.000]), 
		(23, [0.050, 0.010, 0.000, 0.160, 0.010, 0.000]), 
		(27, [0.090, 0.020, 0.000, 0.460, 0.000, 0.000]), 
		(31, [0.160, 0.040, 0.000, 1.140, 0.000, 0.000]), 
		(35, [0.240, 0.080, 0.000, 2.700, 0.000, 0.000]), 
		(39, [0.360, 0.130, 0.000, 5.560, 0.000, 0.000]), 
		(43, [0.530, 0.190, 0.010, 10.830, 0.000, 0.000]), 
		(47, [0.750, 0.290, 0.000, 20.220, 0.000, 0.010]), 
		(51, [1.030, 0.410, 0.010, 35.590, 0.000, 0.000]), 
		(55, [1.390, 0.580, 0.010, 61.600, 0.010, 0.000]), 
		(59, [1.840, 0.860, 0.010, 100.480, 0.000, 0.000]), 
		(63, [2.400, 1.170, 0.010, 155.510, 0.000, 0.010]), 
		(67, [3.030, 1.550, 0.020, 238.470, 0.010, 0.000]), 
		(71, [3.900, 2.040, 0.020, 360.950, 0.000, 0.000]), 
		(75, [4.900, 2.670, 0.030, 558.500, 0.000, 0.000]), 
		(79, [6.090, 3.440, 0.030, 827.870, 0.000, 0.000]), 
		(83, [7.280, 4.340, 0.030, 1208.980, 0.000, 0.000]), 
		(87, [8.600, 5.400, 0.040, 1690.270, 0.010, 0.000]), 
		(91, [10.180, 6.720, 0.060, 2686.100, 0.000, 0.010]), 
		(95, [12.460, 8.240, 0.070, 3730.310, 0.010, 0.000]), 
		(99, [14.840, 10.120, 0.090, 5197.070, 0.010, 0.000]), 
		(103, [17.230, 12.210, 0.100, 7130.850, 0.010, 0.000]), 
		(107, [20.100, 14.840, 0.130, 9839.570, 0.010, 0.000]), 
		(111, [23.270, 17.840, 0.150, 12596.180, 0.010, 0.010]), 
		(115, [26.780, 21.110, 0.170, 17334.070, 0.010, 0.000]), 
		(119, [30.630, 25.420, 0.200, 23059.740, 0.020, 0.010]), 
		(123, [34.960, 30.110, 0.240, 30163.180, 0.020, 0.010]), 
		(127, [39.490, 35.550, 0.270, 38906.970, 0.030, 0.010])
    ],
    (5, 3): [
		(2, [0.000, 0.000, 0.000, 0.000, 0.000, 0.000]), 
		(6, [0.000, 0.000, 0.000, 0.010, 0.000, 0.000]), 
		(10, [0.000, 0.000, 0.000, 0.000, 0.000, 0.000]), 
		(14, [0.010, 0.000, 0.000, 0.000, 0.000, 0.000]), 
		(18, [0.030, 0.000, 0.000, 0.010, 0.000, 0.000]), 
		(22, [0.040, 0.010, 0.000, 0.050, 0.000, 0.000]), 
		(26, [0.080, 0.010, 0.000, 0.180, 0.000, 0.000]), 
		(30, [0.140, 0.020, 0.000, 0.520, 0.000, 0.000]), 
		(34, [0.210, 0.050, 0.000, 1.280, 0.000, 0.000]), 
		(38, [0.330, 0.080, 0.000, 2.900, 0.000, 0.000]), 
		(42, [0.490, 0.130, 0.000, 6.150, 0.000, 0.000]), 
		(46, [0.690, 0.210, 0.000, 12.160, 0.000, 0.000]), 
		(50, [0.950, 0.300, 0.010, 22.640, 0.000, 0.000]), 
		(54, [1.310, 0.440, 0.000, 40.090, 0.000, 0.000]), 
		(58, [1.730, 0.610, 0.000, 66.250, 0.000, 0.000]), 
		(62, [2.230, 0.850, 0.010, 108.690, 0.000, 0.000]), 
		(66, [2.890, 1.160, 0.010, 177.170, 0.000, 0.000]), 
		(70, [3.690, 1.530, 0.020, 275.940, 0.000, 0.000]), 
		(74, [4.610, 2.020, 0.020, 421.990, 0.000, 0.000]), 
		(78, [5.660, 2.610, 0.020, 620.880, 0.000, 0.000]), 
		(82, [6.890, 3.300, 0.030, 912.800, 0.000, 0.000]), 
		(86, [8.350, 4.290, 0.030, 1315.520, 0.010, 0.000]), 
		(90, [10.080, 5.660, 0.050, 1836.450, 0.000, 0.000]), 
		(94, [11.820, 6.930, 0.050, 2903.600, 0.010, 0.010]), 
		(98, [14.020, 8.540, 0.070, 3929.810, 0.010, 0.000]), 
		(102, [16.530, 10.420, 0.080, 5376.320, 0.000, 0.000]), 
		(106, [19.080, 12.590, 0.090, 7431.370, 0.010, 0.000]), 
		(110, [22.170, 15.210, 0.100, 10139.880, 0.010, 0.010]), 
		(114, [25.970, 18.370, 0.150, 13570.240, 0.010, 0.000]), 
		(118, [29.110, 21.560, 0.160, 17494.080, 0.010, 0.010]), 
		(122, [33.210, 25.810, 0.180, 23031.150, 0.020, 0.010]), 
		(126, [37.940, 30.500, 0.210, 30411.940, 0.030, 0.010]), 
		(130, [42.560, 35.490, 0.240, 39266.050, 0.030, 0.010])
    ]
}


for num, ((q, t), data) in enumerate(datasets.items()):
	print(num, q, t)

	# Unpack data and convert to NumPy arrays for subsequent analysis
	x_vals, y_vals = zip(*data)
	timesVS, timesMat, timesInv, timesCP, timesAn1, timesAn2 = zip(*y_vals)

	x_vals = np.array(x_vals)
	timesVS = np.array(timesVS)
	timesMat = np.array(timesMat)
	timesInv = np.array(timesInv)
	timesCP = np.array(timesCP)

	# Combine two measurements that make up Step 1 in the article
	list1 = np.array([a + b for a, b in zip(timesVS, timesInv)])

	# Create figure
	fig, ax = plt.subplots(figsize=(8, 6))

	# Helper function: perform log–log linear fit and return slope and intercept; 
    # and also plot both data and fit
	def loglog_fit(x, y, step):
		# Decoration and colors for each step
		label = f'Step {step}'
		if step == 1:
			color1 = 'darkorange'
			color2 = 'gold'
		elif step == 2:
			color1 = 'blue'
			color2 = 'dodgerblue'
		else:
			color1 = 'purple'
			color2 = 'mediumorchid'
		
		# Mask to exclude non-positive values to avoid errors when taking log
		# exclude smallest times up to half a second as these are inprecise and distort the fit
		mask = (x > 0) & (y > 0.5)
		x_valid, y_valid = x[mask], y[mask]

		# Perform log–log fit with NumPy
		logx = np.log10(x_valid)
		logy = np.log10(y_valid)
		slope, intercept = np.polyfit(logx, logy, 1)

		# Print results
		print(f"{label}: slope = {slope:.3f}, intercept (log10(a)) = {intercept:.3f}")

		# Plot data and fitted line
		ax.plot(x[(x > 9) & (y > 0) & (y <= 0.5)], y[(x > 9) & (y > 0) & (y <= 0.5)], marker='o', fillstyle='none', linestyle='none', label='', color=color1)
		ax.plot(x_valid, y_valid, 'o', label=label, color=color1)
		exponent_string = f"{slope:.2f}"
		ax.plot(x[(x > 9) & (y > 0)], 10**intercept * x[(x > 9) & (y > 0)]**slope, '--', label= label + ' fit: ~ $k^{' + exponent_string + '}$', color=color2)

		return slope, intercept

	# Fit and plot for each step
	slope1, intercept1 = loglog_fit(x_vals, list1, 1)
	slope2, intercept2 = loglog_fit(x_vals, timesMat, 2)
	slope3, intercept3 = loglog_fit(x_vals, timesCP, 3)

	# Configure plot
	ax.set_xscale('log')
	ax.set_yscale('log')

	# Ensure ticks, labels, and limits are the same for all four plots
	new_ticks = [10**t for t in range(-3, 6)] 
	new_labels = ['$\\mathdefault{10^{-3}}$', '$\\mathdefault{10^{-2}}$', '$\\mathdefault{10^{-1}}$', '$\\mathdefault{10^{0}}$', '$\\mathdefault{10^{1}}$', '$\\mathdefault{10^{2}}$', '$\\mathdefault{10^{3}}$', '$\\mathdefault{10^{4}}$', '$\\mathdefault{10^{5}}$']
	ax.set_yticks(new_ticks)
	ax.set_yticklabels(new_labels)
	ax.minorticks_off()
	
	ax.set_xlim(9, 135)
	ax.set_ylim(10**(-3), 10**5)
	
	# Add labels and legend
	ax.set_xlabel('weight $k$')
	ax.set_ylabel('runtime in seconds')
	ax.legend(loc='upper left')
	ax.grid(True) 
	
	# Finish and save
	plt.tight_layout()
	fig.suptitle(f"Runtimes for $q={q}$, type=${t}$", y=1.05)
	plt.savefig(f"plot_times_q{q}type{t}.png", bbox_inches='tight')
	plt.close(fig) 
